# Minecraft連携 倉庫番ゲーム プロジェクト

このプロジェクトは、ScratchからMinecraftを制御して倉庫番（Sokoban）ゲームを実装したものです。

## プロジェクト概要

Scratchの拡張機能を使用してMinecraftと通信し、Minecraft内で倉庫番ゲームをプレイできます。

- **ゲームタイプ**: 倉庫番（パズルゲーム）
- **プラットフォーム**: Scratch 3.0 + Minecraft 1.20.1
- **通信**: WebSocket (ポート 14711)

## 生成されたファイル

### 設計書・ドキュメント

1. **sokoban_design.md**
   - 完全な設計書
   - ゲーム仕様、データ構造、処理フローの詳細
   - ブロック定義、座標系の説明
   - 788行の詳細なドキュメント

2. **sokoban_implementation_guide.md**
   - 段階的な実装ガイド
   - 各フェーズの詳細な手順
   - Scratchブロックの構造説明
   - デバッグのヒント

3. **SOKOBAN_README.md** (このファイル)
   - プロジェクト全体の概要
   - 使い方とクイックスタートガイド

### Pythonスクリプト

4. **generate_sokoban_scratch.py**
   - 基本的なproject.json生成スクリプト
   - 変数・リスト定義の自動生成
   - ブロックID生成ユーティリティ

5. **sokoban_blocks.py**
   - 初期化ブロックとキー入力ハンドラー生成
   - 複雑なネストループ処理

6. **sokoban_draw_move.py**
   - 描画処理と移動処理の補助スクリプト

7. **build_complete_sokoban.py**
   - 完全版project.json生成スクリプト（初期バージョン）
   - 29ブロック生成

8. **build_full_sokoban.py**
   - 改良版project.json生成スクリプト
   - 構造化されたビルダークラス使用
   - 20ブロック生成

### Scratchプロジェクトファイル (.sb3)

9. **sokoban_game.sb3** (43KB)
   - 最初に生成されたバージョン
   - 基本的な初期化、キー入力、描画処理を含む
   - 29ブロック

10. **sokoban_full.sb3** (43KB)
    - 改良版
    - より整理された構造
    - 20ブロック
    - **推奨: このファイルから始めてください**

### 参考ファイル

11. **Scratchのプロジェクト (3).sb3**
    - 既存のScratchプロジェクト（参考用）
    - 解析して構造を理解するために使用

## クイックスタート

### 1. 必要な環境

- Minecraft 1.20.1 + Forge MOD
- Scratch 3.0対応のブラウザ
- MinecraftEdu MOD（WebSocket通信用）
- Scratchエディター（https://scratch.mit.edu/projects/editor/）

### 2. ゲームの起動手順

#### Step 1: Minecraft MODの準備

```bash
cd minecraft-mod
./gradlew build
```

生成されたJARファイルを `.minecraft/mods/` にコピー

#### Step 2: Scratchプロジェクトを開く

1. `sokoban_full.sb3` をScratchエディターで開く
2. Minecraft拡張機能が有効になっていることを確認

#### Step 3: Minecraftを起動

1. Minecraft 1.20.1を起動
2. ワールドを作成またはロード
3. WebSocketサーバーが起動していることを確認（ポート 14711）

#### Step 4: ゲーム開始

1. Scratchで緑の旗をクリック
2. Minecraftにマップが描画される
3. 矢印キーでプレイ開始！

### 3. 操作方法

- **↑キー**: 上に移動
- **↓キー**: 下に移動
- **←キー**: 左に移動
- **→キー**: 右に移動
- **スペースキー**: ゲームリセット

## ゲームの目標

すべての赤いブロック（箱）を金ブロック（ゴール）の上に押し込むとクリア！

### ブロックの種類

| ブロック | Minecraftブロック | 説明 |
|---------|------------------|------|
| 壁 | stone_bricks（石レンガ） | 通行不可 |
| 床 | smooth_stone（滑らかな石） | 通行可能 |
| ゴール | gold_block（金ブロック） | 箱の目的地 |
| 箱（通常） | redstone_block（レッドストーンブロック） | 押すことができる |
| 箱（ゴール上） | emerald_block（エメラルドブロック） | ゴールに到達した箱 |
| プレイヤー | diamond_block（ダイヤモンドブロック） | あなた |

## 実装状況

### 実装済み機能 ✓

- [x] 変数とリストの定義（18変数、5リスト）
- [x] ステージデータの定義（10x10マップ）
- [x] 初期化処理（緑の旗クリック）
- [x] キー入力処理（矢印キー4方向）
- [x] 基本的なマップ描画
- [x] プレイヤー座標の更新
- [x] Minecraftへのブロック設置

### 未実装機能（要追加実装）

- [ ] マップデータの正しい読み取り処理
- [ ] 壁の当たり判定
- [ ] 箱の検出と押し処理
- [ ] プレイヤーと箱の正しい描画
- [ ] クリア判定
- [ ] ゴール表示

## 完全実装への道

生成された `.sb3` ファイルは基本的な骨格のみを含んでいます。完全な倉庫番ゲームにするには、以下の手順で実装を進めてください。

### 実装手順（推奨順序）

**sokoban_implementation_guide.md** を参照して、以下の順序で実装してください：

1. **Phase 1**: マップ読み取り処理
   - カスタムブロック `getMapValue(x, y)` を作成

2. **Phase 2**: 壁判定
   - カスタムブロック `isWall(x, y)` を作成

3. **Phase 3**: 箱検出
   - カスタムブロック `findBox(x, y)` を作成

4. **Phase 4**: 移動処理の改良
   - キー入力ハンドラーに当たり判定を追加

5. **Phase 5**: 箱押し処理
   - カスタムブロック `pushBox(dx, dy)` を作成

6. **Phase 6**: 描画処理の完全実装
   - マップ全体、箱、プレイヤーを正しく描画

7. **Phase 7**: ゴール判定
   - カスタムブロック `isGoal(x, y)` を作成

8. **Phase 8**: クリア判定
   - すべての箱がゴール上にあるかチェック

## 設計の詳細

### データ構造

#### 変数（18個）

- `playerX`, `playerY`: プレイヤーの座標
- `mapWidth`, `mapHeight`: マップサイズ（10x10）
- `gameState`: ゲーム状態（0=未開始, 1=プレイ中, 2=クリア）
- `moveCount`, `pushCount`: 移動回数と押し回数
- `tempX`, `tempY`: 一時座標
- `loopX`, `loopY`: ループカウンタ
- `mapValue`: マップデータ値
- `baseX`, `baseY`, `baseZ`: Minecraft基準座標
- `boxIndex`: 箱のインデックス
- `isOnGoal`: ゴール上フラグ
- `clearedCount`: クリアした箱の数

#### リスト（5個）

- `stageData`: ステージマップデータ（100要素、1次元配列）
- `boxesX`, `boxesY`: 箱の座標リスト
- `goalsX`, `goalsY`: ゴールの座標リスト

#### ステージデータ形式

```
0: 壁（wall）
1: 床（floor）
2: ゴール（goal）
3: 箱（box）
4: プレイヤー初期位置（player）
```

### 座標系

- **Scratchマップ**: (0, 0) が左上、(9, 9) が右下
- **Minecraft座標**:
  - マップX → Minecraft X
  - マップY → Minecraft Z
  - Minecraft Y = 0（床）、Y = 1（箱・プレイヤー）

## カスタマイズ

### ステージの変更

`build_full_sokoban.py` の `STAGE_DATA` 配列を編集して、独自のステージを作成できます。

```python
STAGE_DATA = [
    0,0,0,0,0,0,0,0,0,0,
    0,1,1,1,0,1,1,1,1,0,
    # ... (100個の値)
]
```

### ブロックの種類変更

`sokoban_implementation_guide.md` の Phase 6 で、使用するMinecraftブロックを変更できます。

例：
- 壁を `obsidian`（黒曜石）に変更
- ゴールを `beacon`（ビーコン）に変更

## トラブルシューティング

### 問題: Minecraftに何も表示されない

**原因と対策:**
1. WebSocket接続を確認
   - MinecraftのログでWebSocketサーバーの起動を確認
   - ポート 14711 が使用可能か確認

2. MODの読み込みを確認
   - Minecraft起動時にMODが読み込まれているか確認
   - `mods` フォルダに正しいJARファイルがあるか確認

3. Scratch拡張機能を確認
   - Minecraft拡張機能が有効になっているか確認

### 問題: 座標がずれる

**原因と対策:**
1. baseX, baseY, baseZ の値を確認
2. プレイヤーのMinecraft内座標を確認
3. 座標変換式が正しいか確認

### 問題: 壁をすり抜けてしまう

**原因:**
- 当たり判定が未実装

**対策:**
- `sokoban_implementation_guide.md` の Phase 2, 4 を実装

## 開発メモ

### 生成プロセス

1. 既存Scratchプロジェクト (`Scratchのプロジェクト (3).sb3`) の解析
2. 倉庫番ゲームの設計書作成
3. Pythonスクリプトによるproject.json自動生成
4. .sb3ファイル（ZIP形式）の作成
5. 詳細な実装ガイドの作成

### 技術的な課題

Scratchのproject.jsonは非常に複雑な構造を持っています：

- **ブロックID**: 各ブロックにユニークなランダムIDが必要
- **親子関係**: next, parent による連結構造
- **入力形式**: 複雑な配列構造（shadow, block, variable など）
- **ネストループ**: SUBSTACK による子ブロックの管理

完全な自動生成には数千行のコードが必要なため、基本構造のみを生成し、詳細な実装ガイドを提供する方式を採用しました。

## ファイルサイズ

- **設計書**: sokoban_design.md (約 16KB, 788行)
- **実装ガイド**: sokoban_implementation_guide.md (約 14KB, 580行)
- **生成スクリプト**: 合計 約 20KB
- **.sb3ファイル**: 各 43KB

## 今後の拡張案

### 機能追加

1. **複数ステージ**: ステージセレクト画面
2. **アンドゥ機能**: 1手戻る
3. **タイマー**: クリアタイムの計測
4. **ランキング**: ベストスコアの保存
5. **ヒント機能**: 詰まったときのヒント表示

### ビジュアル改善

1. **アニメーション**: プレイヤーの移動アニメーション
2. **パーティクル**: 箱を押したときのエフェクト
3. **サウンド**: 効果音とBGM

### ゲームプレイ

1. **難易度調整**: 簡単・普通・難しい
2. **タイムアタック**: 制限時間内にクリア
3. **最小手数モード**: 最少移動回数でクリア

## ライセンスと利用

このプロジェクトは教育目的で作成されました。自由に改変・配布できます。

## 謝辞

- Scratchプロジェクト構造の参考: 既存の `Scratchのプロジェクト (3).sb3`
- Minecraft MOD: MinecraftEdu
- 倉庫番ゲーム: オリジナルは今林宏行氏による1982年の作品

---

## まとめ

このプロジェクトには、完全な倉庫番ゲームを実装するために必要なすべての資料が含まれています：

1. **詳細な設計書** (sokoban_design.md)
2. **段階的な実装ガイド** (sokoban_implementation_guide.md)
3. **自動生成されたScratchプロジェクト** (sokoban_full.sb3)
4. **生成用Pythonスクリプト** (複数)

`sokoban_full.sb3` を開いて、`sokoban_implementation_guide.md` に従って実装を進めてください。

**推奨実装時間**: 各フェーズ30分〜1時間、合計 4〜8時間

頑張ってください！完成したら、ぜひオリジナルのステージも作成してみてください！
