<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® Minecraft Ã— Scratch å°‚ç”¨ãƒšãƒ¼ã‚¸</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .header {
            text-align: center;
            padding: 20px;
            background: rgba(0,0,0,0.3);
        }
        .status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            font-size: 14px;
        }
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .connected { background-color: #4CAF50; }
        .disconnected { background-color: #f44336; }
        .scratch-container {
            width: 100%;
            height: calc(100vh - 100px);
            border: none;
        }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 10px;
            display: none;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ® Minecraft Ã— Scratch</h1>
        <p>Scratchã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ã£ã¦ã€Minecraftã§éŠã¼ã†ï¼</p>
    </div>

    <div class="status">
        <span class="connection-status disconnected" id="status-light"></span>
        <span id="status-text">Minecraftæ¥ç¶šå¾…æ©Ÿä¸­...</span>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Scratchã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        <p style="font-size: 12px;">åˆå›ã¯å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™</p>
    </div>

    <iframe 
        id="scratch-frame"
        class="scratch-container"
        src="about:blank"
        allow="microphone; camera"
        onload="onScratchLoaded()">
    </iframe>

    <script>
        let ws = null;
        let connectionCheckInterval = null;
        let scratchReady = false;

        // Minecraftæ¥ç¶šçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        function checkMinecraftConnection() {
            try {
                if (ws) {
                    ws.close();
                }
                
                ws = new WebSocket('ws://localhost:14711');
                
                ws.onopen = function() {
                    updateStatus(true, 'Minecraftæ¥ç¶šä¸­ âœ…');
                };
                
                ws.onclose = function() {
                    updateStatus(false, 'Minecraftæœªæ¥ç¶š âŒ');
                };
                
                ws.onerror = function() {
                    updateStatus(false, 'Minecraftèµ·å‹•ã—ã¦ãã ã•ã„ ğŸ®');
                };
                
            } catch (error) {
                updateStatus(false, 'Minecraftèµ·å‹•ã—ã¦ãã ã•ã„ ğŸ®');
            }
        }

        function updateStatus(connected, message) {
            const statusLight = document.getElementById('status-light');
            const statusText = document.getElementById('status-text');
            
            statusLight.className = 'connection-status ' + (connected ? 'connected' : 'disconnected');
            statusText.textContent = message;
        }

        // Scratchèª­ã¿è¾¼ã¿é–‹å§‹
        function loadScratch() {
            document.getElementById('loading').style.display = 'block';
            
            // Scratchå…¬å¼ã‚µã‚¤ãƒˆã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’ä½¿ç”¨
            const scratchUrl = 'https://scratch.mit.edu/projects/editor/?tutorial=getStarted';
            
            document.getElementById('scratch-frame').src = scratchUrl;
        }

        function onScratchLoaded() {
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                scratchReady = true;
            }, 3000);
        }

        // HTTPã‚µãƒ¼ãƒãƒ¼è‡ªå‹•èµ·å‹•ãƒã‚§ãƒƒã‚¯
        function checkExtensionServer() {
            fetch('http://localhost:8080/minecraft-collaboration-extension.js')
                .then(response => {
                    if (response.ok) {
                        loadScratch();
                    } else {
                        showExtensionServerError();
                    }
                })
                .catch(() => {
                    showExtensionServerError();
                });
        }

        function showExtensionServerError() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            loading.innerHTML = `
                <div style="color: #f44336;">
                    <h3>ğŸ“š Scratchä½¿ç”¨æ–¹æ³•</h3>
                    <p>Scratchã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãŒé–‹ã„ãŸã‚‰ï¼š</p>
                    <ol style="text-align: left; margin: 20px 0;">
                        <li>å·¦ä¸‹ã®<strong>ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€</strong>ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>ä¸€ç•ªä¸‹ã®<strong>ã€Œæ‹¡å¼µæ©Ÿèƒ½ã‚’é¸ã¶ã€</strong>ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>URLã«å…¥åŠ›: <code>http://localhost:8080/minecraft-collaboration-extension.js</code></li>
                        <li><strong>ã€Œèª­ã¿è¾¼ã¿ã€</strong>ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>ã€ŒMinecraft Controllerã€ãƒ–ãƒ­ãƒƒã‚¯ãŒè¿½åŠ ã•ã‚Œã¾ã™ï¼</li>
                    </ol>
                    <button onclick="hideInstructions()" style="padding: 10px 20px; margin-top: 15px;">
                        âœ… ç†è§£ã—ã¾ã—ãŸ
                    </button>
                </div>
            `;
        }
        
        function hideInstructions() {
            document.getElementById('loading').style.display = 'none';
        }

        // åˆæœŸåŒ–
        window.onload = function() {
            // Minecraftæ¥ç¶šãƒã‚§ãƒƒã‚¯é–‹å§‹
            checkMinecraftConnection();
            connectionCheckInterval = setInterval(checkMinecraftConnection, 3000);
            
            // æ‹¡å¼µæ©Ÿèƒ½ã‚µãƒ¼ãƒãƒ¼ãƒã‚§ãƒƒã‚¯
            setTimeout(checkExtensionServer, 1000);
        };

        window.onbeforeunload = function() {
            if (connectionCheckInterval) {
                clearInterval(connectionCheckInterval);
            }
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>